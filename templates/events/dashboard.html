{% extends 'base.html' %}

{% block title %}Dashboard - Velocity Media{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Events Dashboard</h1>
        <p>Discover events in Johannesburg and Pretoria</p>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label for="city-filter">City:</label>
            <select id="city-filter" class="form-control">
                <option value="">All Cities</option>
                <option value="Johannesburg">Johannesburg</option>
                <option value="Pretoria">Pretoria</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="category-filter">Category:</label>
            <select id="category-filter" class="form-control">
                <option value="">All Categories</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="search-input">Search:</label>
            <input type="text" id="search-input" class="form-control" placeholder="Search events...">
        </div>
        
        <div class="filter-group">
            <label for="page-size-select">Per Page:</label>
            <select id="page-size-select" class="form-control">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
            </select>
        </div>
        
        <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
        <button id="clear-filters" class="btn btn-outline">Clear</button>
    </div>
    
    <div class="stats-cards" id="stats-container">
        <!-- Stats will be loaded here -->
    </div>
    
    <div class="events-container">
        <div id="loading" class="loading" style="display: none;">Loading events...</div>
        <div id="events-list" class="events-grid">
            <!-- Events will be loaded here -->
        </div>
        <div id="pagination" class="pagination">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    if (!isAuthenticated()) {
        window.location.href = '/login/';
        return;
    }
    
    // Display username
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('username-display').textContent = user.username || 'User';
    
    // Load saved page size preference
    const savedPageSize = localStorage.getItem('pageSize') || '10';
    document.getElementById('page-size-select').value = savedPageSize;
    
    // Load initial data
    loadStats();
    loadEvents();
    
    // Filter handlers
    document.getElementById('apply-filters').addEventListener('click', function() {
        loadEvents(1); // Reset to page 1 when filters change
    });
    
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('city-filter').value = '';
        document.getElementById('category-filter').value = '';
        document.getElementById('search-input').value = '';
        loadEvents(1); // Reset to page 1
    });
    
    // Page size change handler
    document.getElementById('page-size-select').addEventListener('change', function() {
        const pageSize = this.value;
        localStorage.setItem('pageSize', pageSize);
        loadEvents(1); // Reset to page 1 when page size changes
    });
    
    // Search on Enter
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadEvents(1); // Reset to page 1 when searching
        }
    });
});

async function loadStats() {
    try {
        const stats = await apiCall('/api/events/stats/');
        displayStats(stats);
        populateCategories(stats.by_category);
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

function displayStats(stats) {
    const container = document.getElementById('stats-container');
    container.innerHTML = `
        <div class="stat-card">
            <h3>${stats.total_events}</h3>
            <p>Total Events</p>
        </div>
        <div class="stat-card">
            <h3>${Object.keys(stats.by_city).length}</h3>
            <p>Cities</p>
        </div>
        <div class="stat-card">
            <h3>${Object.keys(stats.by_category).length}</h3>
            <p>Categories</p>
        </div>
    `;
}

function populateCategories(categories) {
    const select = document.getElementById('category-filter');
    Object.keys(categories).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

async function loadEvents(page = 1) {
    const loading = document.getElementById('loading');
    const eventsList = document.getElementById('events-list');
    
    loading.style.display = 'block';
    eventsList.innerHTML = '';
    
    try {
        const city = document.getElementById('city-filter').value;
        const category = document.getElementById('category-filter').value;
        const search = document.getElementById('search-input').value;
        const pageSize = document.getElementById('page-size-select').value;
        
        let url = `/api/events/?page=${page}&page_size=${pageSize}`;
        if (city) url += `&city=${encodeURIComponent(city)}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        const data = await apiCall(url);
        
        if (data.results && data.results.length > 0) {
            displayEvents(data.results);
            displayPagination(data);
        } else {
            eventsList.innerHTML = '<p class="no-events">No events found.</p>';
        }
    } catch (error) {
        eventsList.innerHTML = '<p class="error">Failed to load events. Please try again.</p>';
    } finally {
        loading.style.display = 'none';
    }
}

function displayEvents(events) {
    const container = document.getElementById('events-list');
    
    events.forEach(event => {
        const eventCard = document.createElement('div');
        eventCard.className = 'event-card';
        
        // Generate map URL if coordinates available
        let mapUrl = '';
        if (event.latitude && event.longitude) {
            mapUrl = `https://www.google.com/maps?q=${event.latitude},${event.longitude}`;
        }
        
        eventCard.innerHTML = `
            ${event.image_url ? `
            <div class="event-image">
                <img src="${event.image_url}" alt="${escapeHtml(event.title)}" 
                     onerror="this.src='https://source.unsplash.com/800x600/?event,venue'">
                <div class="event-category-badge">${escapeHtml(event.category || 'General')}</div>
            </div>
            ` : ''}
            <div class="event-content">
                <div class="event-header">
                    <h3><a href="/events/${event.id}/">${escapeHtml(event.title)}</a></h3>
                </div>
                <div class="event-body">
                    <p class="event-venue"><strong>Venue:</strong> ${escapeHtml(event.venue_name || 'N/A')}</p>
                    <p class="event-city"><strong>City:</strong> ${escapeHtml(event.city)}</p>
                    ${event.start_date ? `<p class="event-date"><strong>Date:</strong> ${formatDate(event.start_date)}</p>` : ''}
                    ${event.latitude && event.longitude ? `
                    <div class="event-location">
                        <a href="${mapUrl}" target="_blank" class="location-link">
                            <span class="location-icon">üìç</span>
                            <span>View on Map</span>
                        </a>
                    </div>
                    ` : ''}
                </div>
                <div class="event-footer">
                    ${event.event_url ? `<a href="${event.event_url}" target="_blank" class="btn btn-sm btn-outline">View Details</a>` : ''}
                    <a href="/events/${event.id}/" class="btn btn-sm btn-primary">More Info</a>
                </div>
            </div>
        `;
        container.appendChild(eventCard);
    });
}

function displayPagination(data) {
    const container = document.getElementById('pagination');
    container.innerHTML = '';
    
    // Don't show pagination if only one page
    if (!data.total_pages || data.total_pages <= 1) return;
    
    const pagination = document.createElement('div');
    pagination.className = 'pagination-enhanced';
    
    // Pagination info
    const info = document.createElement('div');
    info.className = 'pagination-info';
    info.innerHTML = `
        <span>Page <strong>${data.current_page}</strong> of <strong>${data.total_pages}</strong></span>
        <span class="pagination-count">(${data.count} total events, ${data.page_size} per page)</span>
    `;
    pagination.appendChild(info);
    
    // Go to page input
    const goToPage = document.createElement('div');
    goToPage.className = 'pagination-goto';
    const input = document.createElement('input');
    input.type = 'number';
    input.min = 1;
    input.max = data.total_pages;
    input.value = data.current_page;
    input.className = 'form-control pagination-input';
    input.placeholder = 'Page';
    input.style.width = '80px';
    input.style.textAlign = 'center';
    
    const goBtn = document.createElement('button');
    goBtn.className = 'btn btn-sm btn-primary';
    goBtn.textContent = 'Go';
    goBtn.onclick = () => {
        const page = parseInt(input.value);
        if (page >= 1 && page <= data.total_pages) {
            loadEvents(page);
        } else {
            alert(`Please enter a page number between 1 and ${data.total_pages}`);
            input.value = data.current_page;
        }
    };
    
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            goBtn.click();
        }
    });
    
    goToPage.appendChild(input);
    goToPage.appendChild(goBtn);
    info.appendChild(goToPage);
    
    // Update page size dropdown to match current page size
    const pageSizeSelect = document.getElementById('page-size-select');
    if (pageSizeSelect && data.page_size) {
        pageSizeSelect.value = data.page_size.toString();
        localStorage.setItem('pageSize', data.page_size.toString());
    }
    
    // Navigation controls
    const controls = document.createElement('div');
    controls.className = 'pagination-controls';
    
    // First page button
    if (data.first_page) {
        const firstBtn = document.createElement('button');
        firstBtn.className = 'btn btn-outline btn-sm';
        firstBtn.innerHTML = '&laquo; First';
        firstBtn.onclick = () => {
            const pageSize = document.getElementById('page-size-select').value;
            loadEvents(1);
        };
        firstBtn.title = 'Go to first page';
        controls.appendChild(firstBtn);
    }
    
    // Previous button
    if (data.previous) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-outline btn-sm';
        prevBtn.innerHTML = '&lsaquo; Prev';
        prevBtn.onclick = () => {
            const page = new URL(data.previous).searchParams.get('page') || 1;
            loadEvents(parseInt(page));
        };
        prevBtn.title = 'Previous page';
        controls.appendChild(prevBtn);
    }
    
    // Page numbers
    const pageNumbers = document.createElement('div');
    pageNumbers.className = 'pagination-numbers';
    
    if (data.page_numbers && data.page_numbers.length > 0) {
        data.page_numbers.forEach(pageNum => {
            if (pageNum === null) {
                // Ellipsis
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbers.appendChild(ellipsis);
            } else {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn btn-sm ${pageNum === data.current_page ? 'btn-primary' : 'btn-outline'}`;
                pageBtn.textContent = pageNum;
                pageBtn.onclick = () => {
                    const pageSize = document.getElementById('page-size-select').value;
                    loadEvents(pageNum);
                };
                pageBtn.title = `Go to page ${pageNum}`;
                if (pageNum === data.current_page) {
                    pageBtn.disabled = true;
                    pageBtn.setAttribute('aria-current', 'page');
                }
                pageNumbers.appendChild(pageBtn);
            }
        });
    }
    
    controls.appendChild(pageNumbers);
    
    // Next button
    if (data.next) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-outline btn-sm';
        nextBtn.innerHTML = 'Next &rsaquo;';
        nextBtn.onclick = () => {
            const page = new URL(data.next).searchParams.get('page') || 1;
            loadEvents(parseInt(page));
        };
        nextBtn.title = 'Next page';
        controls.appendChild(nextBtn);
    }
    
    // Last page button
    if (data.last_page) {
        const lastBtn = document.createElement('button');
        lastBtn.className = 'btn btn-outline btn-sm';
        lastBtn.innerHTML = 'Last &raquo;';
        lastBtn.onclick = () => {
            const pageSize = document.getElementById('page-size-select').value;
            loadEvents(data.total_pages);
        };
        lastBtn.title = 'Go to last page';
        controls.appendChild(lastBtn);
    }
    
    pagination.appendChild(controls);
    container.appendChild(pagination);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-ZA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

